{% extends "base.html" %}

{% block title %}Protection - OracleDBA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-shield-alt"></i> Data Protection</h1>
            <p class="text-muted">ARCHIVELOG, FRA, RMAN, and Flashback configuration</p>
        </div>
    </div>

    <!-- Protection Status -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-archive fa-3x text-primary mb-3"></i>
                    <h6>ARCHIVELOG</h6>
                    <span class="status-badge status-unknown" id="archivelogStatus">Checking...</span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-success w-100 mb-1" onclick="enableArchivelog()">
                            <i class="fas fa-play"></i> Enable
                        </button>
                        <button class="btn btn-sm btn-info w-100" onclick="checkArchivelog()">
                            <i class="fas fa-info-circle"></i> Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-folder fa-3x text-success mb-3"></i>
                    <h6>Fast Recovery Area</h6>
                    <span class="status-badge status-unknown" id="fraStatus">Checking...</span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-success w-100 mb-1" onclick="configureFRA()">
                            <i class="fas fa-cog"></i> Configure
                        </button>
                        <button class="btn btn-sm btn-info w-100" onclick="checkFRA()">
                            <i class="fas fa-info-circle"></i> Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-history fa-3x text-warning mb-3"></i>
                    <h6>Flashback Database</h6>
                    <span class="status-badge status-unknown" id="flashbackStatus">Checking...</span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-success w-100 mb-1" onclick="enableFlashback()">
                            <i class="fas fa-play"></i> Enable
                        </button>
                        <button class="btn btn-sm btn-info w-100" onclick="checkFlashback()">
                            <i class="fas fa-info-circle"></i> Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-save fa-3x text-danger mb-3"></i>
                    <h6>RMAN Backup</h6>
                    <span class="status-badge status-unknown" id="rmanStatus">Ready</span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-success w-100 mb-1" onclick="rmanBackup('full')">
                            <i class="fas fa-database"></i> Full Backup
                        </button>
                        <button class="btn btn-sm btn-warning w-100" onclick="rmanBackup('inc')">
                            <i class="fas fa-plus"></i> Incremental
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RMAN Configuration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cogs"></i> RMAN Configuration
                </div>
                <div class="card-body">
                    <form id="rmanConfigForm" class="row g-3" onsubmit="configureRMAN(event)">
                        <div class="col-md-3">
                            <label class="form-label">Retention Days</label>
                            <input type="number" class="form-control" id="rmanRetention" value="7" min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Backup Destination</label>
                            <input type="text" class="form-control" id="rmanDest" value="/u01/backup">
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="rmanCompress" checked>
                                <label class="form-check-label" for="rmanCompress">
                                    Enable compression
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save"></i> Apply Config
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Flashback Operations -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-undo"></i> Flashback Database
                </div>
                <div class="card-body">
                    <p>Point-in-time database recovery</p>
                    <div class="mb-3">
                        <label class="form-label">Flashback To (minutes ago)</label>
                        <input type="number" class="form-control" id="flashbackMinutes" value="60" min="1">
                    </div>
                    <button class="btn btn-warning w-100" onclick="flashbackDatabase()">
                        <i class="fas fa-history"></i> Flashback Database
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-table"></i> Flashback Table
                </div>
                <div class="card-body">
                    <p>Recover individual table to previous state</p>
                    <div class="mb-3">
                        <label class="form-label">Table Name</label>
                        <input type="text" class="form-control" id="flashbackTable" placeholder="SCHEMA.TABLE_NAME">
                    </div>
                    <button class="btn btn-warning w-100" onclick="flashbackTable()">
                        <i class="fas fa-undo"></i> Flashback Table
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Log -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-history"></i> Action Log</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('protectionOutput').textContent='Ready.'"><i class="fas fa-eraser"></i> Clear</button>
                </div>
                <div class="card-body">
                    <div class="terminal-output" id="protectionOutput" style="max-height:200px">Ready to configure data protection...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', checkAllStatus);
    
    async function checkAllStatus() {
        checkArchivelog();
        checkFRA();
        checkFlashback();
    }
    
    async function checkArchivelog() {
        const badge = document.getElementById('archivelogStatus');
        badge.textContent = 'Checking...';
        badge.className = 'status-badge status-unknown';
        const result = await apiCall('/api/protection/archivelog/status');
        if (result.success) {
            const isEnabled = result.log_mode === 'ARCHIVELOG';
            badge.textContent = isEnabled ? 'ARCHIVELOG' : 'NOARCHIVELOG';
            badge.className = isEnabled ? 'status-badge status-running' : 'status-badge status-stopped';
        } else {
            badge.textContent = 'Error';
            badge.className = 'status-badge status-stopped';
        }
    }
    
    async function checkFRA() {
        const badge = document.getElementById('fraStatus');
        badge.textContent = 'Checking...';
        badge.className = 'status-badge status-unknown';
        const result = await apiCall('/api/protection/fra/status');
        if (result.success) {
            if (result.configured) {
                badge.textContent = `Configured (${result.size_mb} MB)`;
                badge.className = 'status-badge status-running';
            } else {
                badge.textContent = 'Not Configured';
                badge.className = 'status-badge status-stopped';
            }
        } else {
            badge.textContent = 'Error';
            badge.className = 'status-badge status-stopped';
        }
    }
    
    async function checkFlashback() {
        const badge = document.getElementById('flashbackStatus');
        badge.textContent = 'Checking...';
        badge.className = 'status-badge status-unknown';
        const result = await apiCall('/api/protection/flashback/status');
        if (result.success) {
            const isOn = result.flashback_on === 'YES';
            badge.textContent = isOn ? 'Enabled' : 'Disabled';
            badge.className = isOn ? 'status-badge status-running' : 'status-badge status-stopped';
        } else {
            badge.textContent = 'Error';
            badge.className = 'status-badge status-stopped';
        }
    }
    
    async function enableArchivelog() {
        if (!confirm('Enable ARCHIVELOG mode? This will restart the database (SHUTDOWN IMMEDIATE → STARTUP MOUNT → ALTER DATABASE ARCHIVELOG → ALTER DATABASE OPEN).')) return;
        appendOut('Enabling ARCHIVELOG mode (database will restart)...');
        const result = await apiCall('/api/protection/archivelog/enable', 'POST');
        if (result.success) { appendOut('✅ ARCHIVELOG enabled!'); if(result.output) appendOut(result.output); checkArchivelog(); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    async function configureFRA() {
        appendOut('Configuring Fast Recovery Area (10G)...');
        const result = await apiCall('/api/protection/fra/enable', 'POST');
        if (result.success) { appendOut('✅ FRA configured!'); if(result.output) appendOut(result.output); checkFRA(); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    async function enableFlashback() {
        appendOut('Enabling Flashback Database...');
        const result = await apiCall('/api/protection/flashback/enable', 'POST');
        if (result.success) { appendOut('✅ Flashback enabled!'); if(result.output) appendOut(result.output); checkFlashback(); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    async function rmanBackup(type) {
        appendOut(`Starting RMAN ${type} backup (runs in background)...`);
        const result = await apiCall('/api/rman/backup', 'POST', { type: type });
        if (result.success) { appendOut('✅ Backup started! ' + (result.output || '')); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    async function configureRMAN(event) {
        event.preventDefault();
        const retention = document.getElementById('rmanRetention').value;
        appendOut(`Configuring RMAN (retention: ${retention} days)...`);
        const result = await apiCall('/api/rman/configure', 'POST', { retention: parseInt(retention) });
        if (result.success) { appendOut('✅ RMAN configured!'); if(result.output) appendOut(result.output); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    async function flashbackDatabase() {
        const minutes = document.getElementById('flashbackMinutes').value;
        if (!confirm(`Flashback database to ${minutes} minutes ago? This will undo all changes made since then.`)) return;
        const ts = new Date(Date.now() - minutes * 60000).toISOString().replace('T',' ').substring(0,19);
        appendOut(`Flashing back database to ${minutes} minutes ago (${ts})...`);
        const result = await apiCall('/api/flashback/database', 'POST', { timestamp: ts });
        if (result.success) { appendOut('✅ Flashback completed!'); if(result.output) appendOut(result.output); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    async function flashbackTable() {
        const table = document.getElementById('flashbackTable').value;
        if (!table) { alert('Please enter a table name'); return; }
        const minutes = prompt('Flashback to how many minutes ago?', '60');
        if (!minutes) return;
        const ts = new Date(Date.now() - parseInt(minutes) * 60000).toISOString().replace('T',' ').substring(0,19);
        appendOut(`Flashing back table ${table} to ${minutes} minutes ago...`);
        const result = await apiCall('/api/flashback/table', 'POST', { table: table, timestamp: ts });
        if (result.success) { appendOut('✅ Table flashback completed!'); if(result.output) appendOut(result.output); }
        else { appendOut(`❌ Error: ${result.error}`); }
    }
    
    function appendOut(text) {
        const output = document.getElementById('protectionOutput');
        const ts = new Date().toLocaleTimeString();
        output.textContent += `\n[${ts}] ${text}`;
        output.scrollTop = output.scrollHeight;
    }
</script>
{% endblock %}
