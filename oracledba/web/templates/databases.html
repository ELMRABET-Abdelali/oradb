{% extends "base.html" %}

{% block title %}Databases - OracleDBA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-database"></i> Database Management</h1>
            <p class="text-muted">Create and manage Oracle databases</p>
        </div>
    </div>

    <!-- Create Database -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-plus"></i> Create New Database
                </div>
                <div class="card-body">
                    <form id="createDbForm" onsubmit="createDatabase(event)">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Database SID</label>
                                    <input type="text" class="form-control" id="dbSid" value="PRODDB" required>
                                    <small class="text-muted">Unique identifier (e.g., PRODDB, TESTDB)</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Memory (MB)</label>
                                    <input type="number" class="form-control" id="dbMemory" value="2048" min="1024" required>
                                    <small class="text-muted">Minimum 1024 MB recommended</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Character Set</label>
                                    <select class="form-select" id="dbCharset">
                                        <option value="AL32UTF8" selected>AL32UTF8 (UTF-8)</option>
                                        <option value="WE8ISO8859P1">WE8ISO8859P1 (Western European)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Database
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Database List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list"></i> Existing Databases</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadDatabases()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="databaseList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Loading databases...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Output -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-terminal"></i> Output
                </div>
                <div class="card-body">
                    <div class="terminal-output" id="dbOutput">
Ready to manage databases...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load on page load
    document.addEventListener('DOMContentLoaded', loadDatabases);
    
    async function loadDatabases() {
        const listDiv = document.getElementById('databaseList');
        listDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        
        const result = await apiCall('/api/databases/list');
        
        if (result.success) {
            displayDatabases(result.output);
        } else {
            listDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
        }
    }
    
    function displayDatabases(output) {
        const listDiv = document.getElementById('databaseList');
        
        // Parse output (this is a simplified version - adjust based on actual output format)
        if (output.includes('No databases found') || output.trim() === '') {
            listDiv.innerHTML = '<div class="alert alert-info">No databases found. Create one above.</div>';
            return;
        }
        
        listDiv.innerHTML = `<pre class="mb-0">${output}</pre>`;
    }
    
    async function createDatabase(event) {
        event.preventDefault();
        
        const sid = document.getElementById('dbSid').value;
        const memory = document.getElementById('dbMemory').value;
        
        appendDbOutput(`Creating database ${sid} with ${memory}MB memory...`);
        
        const result = await apiCall('/api/databases/create', 'POST', {
            sid: sid,
            memory: parseInt(memory)
        });
        
        if (result.success) {
            appendDbOutput('✅ Database created successfully!');
            appendDbOutput(result.output);
            loadDatabases();
        } else {
            appendDbOutput(`❌ Error: ${result.error}`);
        }
    }
    
    function appendDbOutput(text) {
        const output = document.getElementById('dbOutput');
        const timestamp = new Date().toLocaleTimeString();
        output.textContent += `\n[${timestamp}] ${text}`;
        output.scrollTop = output.scrollHeight;
    }
</script>
{% endblock %}
